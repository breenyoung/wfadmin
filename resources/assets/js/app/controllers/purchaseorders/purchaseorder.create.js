(function(){
    "use strict";

    function PurchaseOrderCreateController($auth, $state, $scope, $moment, Restangular, ToastService, RestService, DialogService, ValidationService, $stateParams)
    {
        var self = this;

        RestService.getAllCustomers(self);
        RestService.getAllProducts(self);
        RestService.getAllPaymentTypes(self);
        //RestService.getFullyBookedDays(self);

        RestService.getAllSalesChannels().then(function(data)
        {
            self.saleschannels = data;
        });

        self.purchaseorder = {};
        self.purchaseorder.amount_paid = 0;
        self.purchaseorder.discount = 0;
        self.purchaseorder.total = 0;

        self.purchaseorder.delivery = 0;
        self.delivery_charge = 0;

        self.purchaseorder.shipping = 0;
        self.shipping_charge = 0;

        self.purchaseorder.suppressworkorder = 0;

        var originalTotal = 0;
        var originalShippingCharge = 0;

        self.addProductInline = function(ev)
        {
            var dialogOptions = {
                templateUrl: '/views/dialogs/dlgCreateProductInline.html',
                escapeToClose: true,
                targetEvent: ev,
                controller: function DialogController($scope, $mdDialog)
                {
                    $scope.decimalRegex = ValidationService.decimalRegex();

                    $scope.confirmDialog = function ()
                    {
                        //console.log('accepted');

                        $scope.form1.$setSubmitted();

                        var isValid = $scope.form1.$valid;
                        if(isValid)
                        {
                            var p = $scope.ctrlProductCreateInline.product;
                            p.cost = 0;
                            p.minimum_stock = 0;
                            p.current_stock = 0;
                            //console.log(p);

                            RestService.addProduct(p).then(function(d)
                            {
                                //console.log(d.newId);
                                var pop = {id: d.newId, name: p.name, price: p.price};
                                self.products.push(pop);
                                self.selectedProduct = pop;
                                ToastService.show("Product Successfully created");
                            }, function()
                            {
                                ToastService.show("Error creating product");
                            });

                            $mdDialog.hide();
                        }
                    };

                    $scope.cancelDialog = function()
                    {
                        //console.log('cancelled');
                        $mdDialog.hide();
                    };
                },
                scope: $scope.$new()
            };

            DialogService.fromCustom(dialogOptions);

        };

        self.addCustomerInline = function(ev)
        {
            var dialogOptions = {
                templateUrl: '/views/dialogs/dlgCreateCustomerInline.html',
                escapeToClose: true,
                targetEvent: ev,
                controller: function DialogController($scope, $mdDialog)
                {
                    $scope.confirmDialog = function ()
                    {
                        //console.log('accepted');

                        $scope.form1.$setSubmitted();

                        var isValid = $scope.form1.$valid;
                        if(isValid)
                        {
                            var c = $scope.ctrlCustomerCreateInline.customer;
                            console.log(c);

                            RestService.addCustomer(c).then(function(d)
                            {
                                console.log(d.newId);
                                self.customers.push({id: d.newId, first_name: c.first_name, last_name: c.last_name });
                                self.purchaseorder.customer_id = d.newId;
                                ToastService.show("Customer Successfully created");
                            }, function()
                            {
                                ToastService.show("Error creating customer");
                            });

                            $mdDialog.hide();
                        }
                    };

                    $scope.cancelDialog = function()
                    {
                        //console.log('cancelled');
                        $mdDialog.hide();
                    };
                },
                scope: $scope.$new()
            };

            DialogService.fromCustom(dialogOptions);
        };

        self.onlyOpenDays = function(date)
        {
            var result = true;

            if(!$moment(date).isBefore())
            {
                //console.log(date);
                for(var i = 0; i < self.bookedDays.length; i++)
                {
                    //console.log(self.bookedDays[i].start_date);
                    //console.log(self.bookedDays[i].start_date);
                    //console.log($moment(self.bookedDays[i].start_date));
                    if(moment(date).isSame(self.bookedDays[i].start_date))
                    {
                        result = false;
                        break;
                    }
                }
            }

            return result;
        };

        self.createPurchaseOrder = function()
        {
            console.log(self.purchaseorder);

            var p = self.purchaseorder;

            //console.log($error);
            Restangular.all('purchaseorder').post(p).then(function(d)
            {
                console.log(d);
                //$state.go('app.products.detail', {'productId': d.newId});
                ToastService.show("Successfully created");
                if(d.newWoIds && d.newWoIds.length > 0)
                {
                    var linkObj = [];
                    linkObj.push({LinkText: 'View All POs', LinkUrl: $state.href('app.purchaseorders')});
                    linkObj.push({LinkText: 'View Created PO', LinkUrl: $state.href('app.purchaseorders.detail', {purchaseOrderId: d.newId})});
                    for(var i = 0; i < d.newWoIds.length; i++)
                    {
                        linkObj.push({LinkText: 'View WO #' + d.newWoIds[i], LinkUrl: $state.href('app.workorders.detail', {workOrderId: d.newWoIds[i]})});
                    }

                    $scope.linksToShow = linkObj;

                    DialogService.fromTemplate(null, 'dlgLinkChooser', $scope);
                }
                else
                {
                    $state.go('app.purchaseorders');
                }

            }, function()
            {
                ToastService.show("Error creating");
            });

        };

        self.applyDiscount = function()
        {
            if(self.purchaseorder.discount == null || self.purchaseorder.discount == 0)
            {
                self.purchaseorder.total = originalTotal;
            }
            else
            {
                if(self.purchaseorder.total !== undefined
                    && self.purchaseorder.total !== null
                    && self.purchaseorder.total > 0)
                {
                    var discounted = originalTotal - self.purchaseorder.discount;
                    discounted >= 0 ? self.purchaseorder.total = discounted : 0;
                }
            }
        };

        self.applyDelivery = function()
        {
            if(self.delivery_charge === 1)
            {
                self.purchaseorder.delivery = deliveryFee;
                self.purchaseorder.total += deliveryFee;
            }
            else
            {
                self.purchaseorder.delivery = 0;
                self.purchaseorder.total -= deliveryFee;
            }
        };

        self.applyShipping = function()
        {
            var costOfShipping = 0;
            if(self.shipping_charge === 'CDN')
            {
                costOfShipping = shippingCanada;
            }
            else if(self.shipping_charge === 'USA')
            {
                costOfShipping = shippingUsa;
            }

            self.purchaseorder.shipping = costOfShipping;

            if(self.shipping_charge !== originalShippingCharge)
            {
                self.purchaseorder.total -= originalShippingCharge;
                self.purchaseorder.total += costOfShipping;

                originalTotal -= originalShippingCharge;
                originalTotal += costOfShipping;
            }

            originalShippingCharge = costOfShipping;
        };
        
        self.addProduct = function()
        {
            console.log(self.selectedProduct);

            if(self.purchaseorder.purchase_order_products === undefined) { self.purchaseorder.purchase_order_products = []; }

            self.purchaseorder.purchase_order_products.push({
                product_id: self.selectedProduct.id,
                quantity: self.selectedQuantity,
                product: self.selectedProduct
            });

            if(self.purchaseorder.total === undefined || self.purchaseorder.total === null) { self.purchaseorder.total = 0; }
            var currentCost = parseFloat(self.purchaseorder.total);
            var btest = (parseFloat(self.selectedProduct.price) * parseInt(self.selectedQuantity));
            currentCost += btest;
            self.purchaseorder.total = currentCost;
            originalTotal = currentCost;

            self.selectedProduct = "";
            self.selectedQuantity = 0;

            console.log(self.purchaseorder);
        };

        self.deleteProduct = function(e, productId)
        {
            var indexToRemove;
            for(var i = 0; i < self.purchaseorder.purchase_order_products.length; i++)
            {
                if(productId == self.purchaseorder.purchase_order_products[i].product_id)
                {
                    indexToRemove = i;
                    break;
                }
            }

            //console.log(indexToRemove);

            var currentCost = parseFloat(self.purchaseorder.total);
            var btest = (parseFloat(self.purchaseorder.purchase_order_products[indexToRemove].product.price) * parseInt(self.purchaseorder.purchase_order_products[indexToRemove].quantity));
            currentCost -= btest;
            self.purchaseorder.total = currentCost;
            originalTotal = currentCost;

            self.purchaseorder.purchase_order_products.splice(indexToRemove, 1);

            e.preventDefault();
        };

        self.determineWorkOrders = function(e)
        {
            if(self.purchaseorder.purchase_order_products !== undefined)
            {
                if(self.purchaseorder.suppressworkorder == 1)
                {
                    // Just process the PO as normal
                    self.createPurchaseOrder();
                }
                else
                {

                    var productsToFulfill = [];
                    for (var i = 0; i < self.purchaseorder.purchase_order_products.length; i++) {
                        productsToFulfill.push({
                            product_id: self.purchaseorder.purchase_order_products[i].product_id,
                            quantity: self.purchaseorder.purchase_order_products[i].quantity
                        });
                    }

                    Restangular.all('scheduler/getWorkOrders').post({productsToFulfill: productsToFulfill}).then(function (data) {
                        console.log(data.workOrdersToCreate);
                        if (data.workOrdersToCreate > 0) {
                            // There are workorders needed for this PO, confirm their creation
                            $scope.workOrdersToCreate = data.workOrdersToCreate;
                            $scope.workOrders = data.workOrders;

                            DialogService.fromTemplate(e, 'dlgConfirmWorkOrders', $scope).then(
                                function () {
                                    self.purchaseorder.work_orders = $scope.workOrders;
                                    //console.log('confirmed');
                                    self.createPurchaseOrder();
                                },
                                function () {
                                    //console.log('cancelled');
                                }
                            );
                        }
                        else {
                            // Just process the PO as normal
                            self.createPurchaseOrder();
                        }
                    });
                }
            }
        };

    }

    angular.module('app.controllers').controller('PurchaseOrderCreateController', ['$auth', '$state', '$scope', '$moment', 'Restangular', 'ToastService', 'RestService', 'DialogService', 'ValidationService', '$stateParams', PurchaseOrderCreateController]);

})();
